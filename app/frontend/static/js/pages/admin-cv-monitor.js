/**
 * MoirAI Admin CV Monitor Page
 * Handles CV generation monitoring and statistics
 * Connected to real SQLite database generated by generate_cvs.py
 */

class AdminCVMonitorPage {
    constructor() {
        this.stats = {
            totalCVs: 0,
            targetCVs: 1000,
            progress: 0,
            industryStats: {},
            seniorityStats: {},
            recentCVs: []
        };
        this.updateInterval = null;
        this.isUpdating = false;
    }

    async initialize() {
        console.log('ðŸŽ­ Inicializando CV Monitor...');
        this.setupEventListeners();
        await this.loadStats();
        this.startAutoUpdate();
    }

    setupEventListeners() {
        // BotÃ³n de refresh
        const refreshBtn = document.getElementById('refresh-btn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => this.refreshStats());
        }

        // BotÃ³n de generar mÃ¡s CVs
        const generateBtn = document.getElementById('generate-btn');
        if (generateBtn) {
            generateBtn.addEventListener('click', () => this.generateMoreCVs());
        }
    }

    async loadStats() {
        try {
            this.isUpdating = true;
            this.showLoadingState();

            // Intentar cargar datos reales primero
            await this.loadRealStats();

            this.updateUI();
            this.hideLoadingState();

        } catch (error) {
            console.error('âŒ Error cargando estadÃ­sticas:', error);
            this.showErrorState(error.message);
        } finally {
            this.isUpdating = false;
        }
    }

    async loadRealStats() {
        try {
            console.log('ðŸ“Š Cargando estadÃ­sticas reales de la base de datos...');

            const apiKey = localStorage.getItem('api_key');
            console.log('ðŸ”‘ API Key from localStorage:', apiKey ? apiKey.substring(0, 10) + '...' : 'NOT FOUND');

            // Hacer peticiÃ³n al endpoint que leerÃ¡ la base de datos SQLite
            const response = await fetch('/api/v1/admin/cv-simulator/stats', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    // Incluir token si existe
                    ...(apiKey && {
                        'X-API-Key': apiKey
                    })
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            console.log('âœ… Datos reales cargados:', data);

            // Mapear respuesta del backend a estructura interna
            this.stats = {
                totalCVs: data.total_cvs || 0,
                targetCVs: data.target || 1000,
                progress: data.progress_percentage || 0,
                industryStats: data.industries || {},
                seniorityStats: data.seniorities || {},
                recentCVs: (data.recent_cvs || []).map(cv => ({
                    id: cv.id,
                    industry: cv.industry,
                    seniority: cv.seniority,
                    created_at: new Date(cv.created_at)
                }))
            };

        } catch (error) {
            console.warn('âš ï¸ No se pudieron cargar estadÃ­sticas reales:', error.message);
            console.log('ðŸ”„ Usando datos de respaldo...');
            await this.loadFallbackStats();
        }
    }

    async loadFallbackStats() {
        // Datos de respaldo cuando no hay conexiÃ³n al backend
        this.stats = {
            totalCVs: 0,
            targetCVs: 1000,
            progress: 0,
            industryStats: {},
            seniorityStats: {},
            recentCVs: []
        };

        // Simular delay de carga
        await new Promise(resolve => setTimeout(resolve, 300));
    }

    updateUI() {
        this.updateProgressCard();
        this.updateIndustryStats();
        this.updateSeniorityStats();
        this.updateRecentActivity();
        this.updateStatus();
    }

    updateProgressCard() {
        const totalElement = document.getElementById('total-cvs');
        const targetElement = document.getElementById('target-cvs');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');

        if (totalElement) totalElement.textContent = this.stats.totalCVs;
        if (targetElement) targetElement.textContent = this.stats.targetCVs;
        if (progressBar) progressBar.style.width = `${this.stats.progress}%`;
        if (progressText) progressText.textContent = `${this.stats.progress.toFixed(1)}%`;
    }

    updateIndustryStats() {
        const container = document.getElementById('industry-list');
        if (!container) return;

        const sortedIndustries = Object.entries(this.stats.industryStats)
            .sort(([,a], [,b]) => b - a);

        if (sortedIndustries.length === 0) {
            container.innerHTML = '<li class="stat-item"><span class="text-muted">No hay datos disponibles</span></li>';
            return;
        }

        container.innerHTML = sortedIndustries.map(([industry, count]) => `
            <li class="stat-item">
                <span>${industry}</span>
                <span class="font-bold">${count}</span>
            </li>
        `).join('');
    }

    updateSeniorityStats() {
        const container = document.getElementById('seniority-list');
        if (!container) return;

        const sortedSeniority = Object.entries(this.stats.seniorityStats)
            .sort(([,a], [,b]) => b - a);

        if (sortedSeniority.length === 0) {
            container.innerHTML = '<li class="stat-item"><span class="text-muted">No hay datos disponibles</span></li>';
            return;
        }

        container.innerHTML = sortedSeniority.map(([seniority, count]) => `
            <li class="stat-item">
                <span>${seniority}</span>
                <span class="font-bold">${count}</span>
            </li>
        `).join('');
    }

    updateRecentActivity() {
        const container = document.getElementById('recent-cvs-table');
        if (!container) return;

        if (this.stats.recentCVs.length === 0) {
            container.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay CVs recientes</td></tr>';
            return;
        }

        container.innerHTML = this.stats.recentCVs.map(cv => `
            <tr>
                <td>#${cv.id.substring(0, 8)}...</td>
                <td>${cv.industry}</td>
                <td><span class="status-badge status-completed">${cv.seniority}</span></td>
                <td>${cv.created_at.toLocaleString('es-ES', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                })}</td>
                <td><i class="fas fa-check-circle text-success"></i> Generado</td>
            </tr>
        `).join('');
    }

    updateStatus() {
        const statusElement = document.getElementById('simulator-status');
        if (statusElement) {
            if (this.stats.totalCVs > 0) {
                statusElement.innerHTML = '<i class="fas fa-sync fa-spin"></i> Datos cargados';
                statusElement.className = 'status-badge status-running';
            } else {
                statusElement.innerHTML = '<i class="fas fa-pause-circle"></i> Sin datos';
                statusElement.className = 'status-badge status-stopped';
            }
        }
    }

    async refreshStats() {
        if (this.isUpdating) return;

        console.log('ðŸ”„ Refrescando estadÃ­sticas...');
        await this.loadStats();

        // Mostrar notificaciÃ³n de Ã©xito
        if (typeof notificationManager !== 'undefined' && notificationManager) {
            notificationManager.success('EstadÃ­sticas actualizadas');
        }
    }

    async generateMoreCVs() {
        try {
            // Mostrar loading
            if (typeof notificationManager !== 'undefined' && notificationManager) {
                notificationManager.loading('Generando CVs adicionales...');
            }

            // Hacer peticiÃ³n para generar mÃ¡s CVs
            const response = await fetch('/api/v1/admin/cv-simulator/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(localStorage.getItem('api_key') && {
                        'X-API-Key': localStorage.getItem('api_key')
                    })
                },
                body: JSON.stringify({
                    count: 5 // Generar 5 CVs por defecto
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();

            // Ocultar loading y mostrar Ã©xito
            if (typeof notificationManager !== 'undefined' && notificationManager) {
                notificationManager.hideLoading();
                notificationManager.success(`${result.generated || 5} CVs generados exitosamente`);
            }

            // Recargar estadÃ­sticas
            await this.refreshStats();

        } catch (error) {
            console.error('âŒ Error generando CVs:', error);

            // Ocultar loading y mostrar error
            if (typeof notificationManager !== 'undefined' && notificationManager) {
                notificationManager.hideLoading();
                notificationManager.error('Error generando CVs: ' + error.message);
            }
        }
    }

    startAutoUpdate() {
        // Actualizar cada 30 segundos
        this.updateInterval = setInterval(() => {
            this.refreshStats();
        }, 30000);
    }

    stopAutoUpdate() {
        if (this.updateInterval) {
            clearInterval(this.updateInterval);
            this.updateInterval = null;
        }
    }

    showLoadingState() {
        const refreshBtn = document.getElementById('refresh-btn');
        if (refreshBtn) {
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...';
        }
    }

    hideLoadingState() {
        const refreshBtn = document.getElementById('refresh-btn');
        if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Actualizar';
        }
    }

    showErrorState(message) {
        this.hideLoadingState();

        if (typeof notificationManager !== 'undefined' && notificationManager) {
            notificationManager.error(`Error: ${message}`);
        }
    }
}

// Inicializar cuando el DOM estÃ© listo
document.addEventListener('DOMContentLoaded', () => {
    // Wait for navbar to initialize first
    const checkNavbarReady = () => {
        if (typeof navbarManager !== 'undefined' && navbarManager && navbarManager.initialized) {
            const cvMonitor = new AdminCVMonitorPage();
            cvMonitor.initialize().catch(error => {
                console.error('âŒ Error inicializando CV Monitor:', error);
            });

            // Cleanup al salir de la pÃ¡gina
            window.addEventListener('beforeunload', () => {
                cvMonitor.stopAutoUpdate();
            });
        } else {
            // Wait a bit more for navbar initialization
            setTimeout(checkNavbarReady, 100);
        }
    };
    
    checkNavbarReady();
});
